<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullstack Test - Simple UI</title>

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { padding: 24px; background:#f8f9fa; }
    .card { margin-bottom: 1rem; }
    .error-box { color: #842029; background: #f8d7da; border-color: #f5c2c7; padding: 12px; border-radius: 6px; }
    .ok-box { color: #0f5132; background: #d1e7dd; border-color:#badbcc; padding: 12px; border-radius:6px; }
    table td, table th { vertical-align: middle; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Simple Frontend — Fullstack Test</h2>

    <div id="alertArea"></div>

    <div class="row">
      <div class="col-md-5">
        <div class="card">
          <div class="card-header">Buat Item</div>
          <div class="card-body">
            <form id="itemForm">
              <div class="mb-3">
                <label class="form-label">Judul</label>
                <input id="title" class="form-control" required />
              </div>

              <div class="mb-3">
                <label class="form-label">Deskripsi</label>
                <textarea id="description" class="form-control" rows="3"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Due date (pilih atau masukkan epoch seconds)</label>
                <input id="dueDatetime" type="datetime-local" class="form-control" />
                <small class="text-muted">Atau masukkan epoch seconds di bawah</small>
                <input id="dueEpoch" placeholder="epoch seconds (optional)" class="form-control mt-2" />
              </div>

              <div class="d-grid gap-2">
                <button id="btnCreate" class="btn btn-primary" type="submit">Buat</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Petunjuk singkat</div>
          <div class="card-body">
            <ul>
              <li>Semua tanggal dikirim sebagai <strong>epoch seconds</strong>.</li>
              <li>Jika Anda pilih <em>datetime-local</em>, frontend akan mengonversi ke epoch (seconds) otomatis.</li>
              <li>Jika server mengembalikan <strong>501</strong>, pesan manusiawi akan ditampilkan di atas form.</li>
              <li>Jika ada masalah CORS, lihat catatan di bawah.</li>
            </ul>
          </div>
        </div>

      </div>

      <div class="col-md-7">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Daftar Item</span>
            <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              <table id="itemsTable" class="table table-striped m-0">
                <thead class="table-light">
                  <tr>
                    <th>Judul</th>
                    <th>Deskripsi</th>
                    <th>Due Date</th>
                    <th>Created At</th>
                    <th style="width:120px">Aksi</th>
                  </tr>
                </thead>
                <tbody id="itemsTbody">
                  <!-- rows inserted by JS -->
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

    <footer class="mt-4 text-muted">
      Backend: <code>http://localhost:8080/api/v1/items</code> — pastikan backend berjalan (Java 17, Spring Boot).
    </footer>
  </div>

  <!-- Bootstrap + optional Popper (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // API base
    const API = 'http://localhost:8080/api/v1/items';

    // helpers
    function epochFromDatetimeLocal(value) {
      // value example: "2025-12-12T17:30"
      if(!value) return null;
      const dt = new Date(value);
      // convert to seconds
      return Math.floor(dt.getTime() / 1000);
    }

    function formatEpoch(epoch) {
      if (!epoch && epoch !== 0) return '-';
      const d = new Date(epoch * 1000);
      return d.toLocaleString();
    }

    function showAlert(type, title, message) {
      // type: 'error' | 'success' | 'info'
      const div = document.getElementById('alertArea');
      let html = '';
      if(type === 'error') {
        html = `<div class="error-box mb-3"><strong>${title}</strong><div>${message}</div></div>`;
      } else {
        html = `<div class="ok-box mb-3"><strong>${title}</strong><div>${message}</div></div>`;
      }
      div.innerHTML = html;
      // auto hide after 6s
      setTimeout(()=> { if(div.innerHTML.includes(title)) div.innerHTML = ''; }, 6000);
    }

    async function fetchItems() {
      try {
        const res = await fetch(API);
        if (!res.ok) {
          showAlert('error', 'Gagal memuat data', `Status: ${res.status}`);
          return;
        }
        const data = await res.json();
        renderItems(data);
      } catch (err) {
        showAlert('error', 'Network Error', err.message);
      }
    }

    function renderItems(items) {
      const tbody = document.getElementById('itemsTbody');
      tbody.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Belum ada item</td></tr>`;
        return;
      }

      for (const it of items) {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${escapeHtml(it.title)}</td>
          <td>${escapeHtml(it.description || '')}</td>
          <td>${formatEpoch(it.dueEpoch)}</td>
          <td>${formatEpoch(it.createdAtEpoch)}</td>
          <td>
            <button class="btn btn-sm btn-danger me-1" data-id="${it.id}" onclick="deleteItem(${it.id})">Hapus</button>
            <button class="btn btn-sm btn-secondary" data-id="${it.id}" onclick="prefillEdit(${it.id})">Edit</button>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    // very small escape helper
    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    async function createItem(payload) {
      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 201 || res.status === 200) {
          const body = await res.json();
          showAlert('success', 'Berhasil', 'Item berhasil dibuat.');
          await fetchItems();
          return;
        }

        if (res.status === 501) {
          const errBody = await res.json();
          // tampilkan pesan manusiawi dari server
          showAlert('error', 'Validasi / Business Error', errBody.message || JSON.stringify(errBody));
          return;
        }

        // other errors
        const text = await res.text();
        showAlert('error', 'Kesalahan', `Status ${res.status}: ${text}`);
      } catch (err) {
        showAlert('error', 'Network Error', err.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm('Hapus item ini?')) return;
      try {
        const res = await fetch(API + '/' + id, { method: 'DELETE' });
        if (res.status === 204) {
          showAlert('success', 'Dihapus', 'Item berhasil dihapus.');
          await fetchItems();
          return;
        }
        const text = await res.text();
        showAlert('error', 'Gagal Hapus', `${res.status}: ${text}`);
      } catch (err) {
        showAlert('error', 'Network Error', err.message);
      }
    }

    // simple edit: prefill form then call update on submit
    let editingId = null;
    function prefillEdit(id) {
      const row = Array.from(document.querySelectorAll('#itemsTbody tr')).find(r => r.querySelector(`[data-id="${id}"]`));
      // fallback: reload list and find item
      fetch(API).then(r=>r.json()).then(items => {
        const it = items.find(x=>x.id === id);
        if (!it) return;
        editingId = id;
        document.getElementById('title').value = it.title || '';
        document.getElementById('description').value = it.description || '';
        // set datetime-local input from epoch
        if (it.dueEpoch) {
          const d = new Date(it.dueEpoch * 1000);
          // to yyyy-MM-ddThh:mm
          const pad = (n) => n.toString().padStart(2,'0');
          const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
          document.getElementById('dueDatetime').value = local;
          document.getElementById('dueEpoch').value = it.dueEpoch;
        }
      });
    }

    document.getElementById('itemForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const dueLocal = document.getElementById('dueDatetime').value;
      const dueEpochInput = document.getElementById('dueEpoch').value.trim();

      let epoch = null;
      if (dueEpochInput) {
        // if user typed epoch directly
        epoch = Number(dueEpochInput);
      } else if (dueLocal) {
        epoch = epochFromDatetimeLocal(dueLocal);
      }

      // if still null, let backend handle validation (and we will show 501)
      const payload = { title, description };
      if (epoch !== null && !Number.isNaN(epoch)) payload.dueEpoch = epoch;

      if (editingId) {
        // update
        try {
          const res = await fetch(API + '/' + editingId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            showAlert('success','Diperbarui','Item berhasil diperbarui.');
            editingId = null;
            document.getElementById('itemForm').reset();
            await fetchItems();
            return;
          }
          if (res.status === 501) {
            const b = await res.json();
            showAlert('error','Business Error', b.message || JSON.stringify(b));
            return;
          }
          const txt = await res.text();
          showAlert('error','Error', `${res.status} ${txt}`);
        } catch (err) {
          showAlert('error','Network Error', err.message);
        }
      } else {
        // create
        await createItem(payload);
        document.getElementById('itemForm').reset();
      }
    });

    document.getElementById('btnRefresh').addEventListener('click', fetchItems);

    // initial load
    fetchItems();

    // CORS note: if browser blocks requests due to CORS, either:
    // - run this file via a simple static server (recommended), OR
    // - enable @CrossOrigin in backend controller (see README)
  </script>
</body>
</html>
